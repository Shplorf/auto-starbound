---

- name: Ensure Starbound is stopped
  service:
    name: starbound
    state: stopped
  become_user: steam

- name: Compress universe folder
  shell: zip -r universe.zip universe
  args:
    chdir: /home/steam/starbound/storage

- name: Backup universe to S3
  s3:
    mode: put
    src: /home/steam/starbound/storage/universe.zip
    object: universe.zip
    bucket: "{{ backup_s3_bucket }}"
    aws_access_key: "{{ aws_access_key }}"
    aws_secret_key: "{{ aws_secret_key }}"

- name: Ensure universe archive is removed
  file:
    path: /home/steam/starbound/storage/universe.zip
    state: absent
  
- name: Ensure Starbound is started
  service:
    name: starbound
    state: started
  become_user: steam